!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-selection"),require("d3-dispatch"),require("d3-transition"),require("d3-timer"),require("d3-interpolate"),require("d3-zoom"),require("viz.js"),require("d3-format")):"function"==typeof define&&define.amd?define(["exports","d3-selection","d3-dispatch","d3-transition","d3-timer","d3-interpolate","d3-zoom","viz.js","d3-format"],e):e(t.d3=t.d3||{},t.d3,t.d3,t.d3,t.d3,t.d3,t.d3,t.Viz,t.d3)}(this,function(t,e,n,r,i,a,o,s,l){"use strict";function h(t){var e={},n=t.node().nodeName;e.tag=n,"#text"==n?e.text=t.text():"#comment"==n&&(e.comment=t.text()),e.attributes={};var r=t.node().attributes;if(r)for(var i=0;i<r.length;i++){var a=r[i],o=a.name,s=a.value;e.attributes[o]=s}var l=t.node().transform;if(l&&0!=l.baseVal.numberOfItems){var h=l.baseVal.consolidate().matrix;e.translation={x:h.e,y:h.f}}if("ellipse"==n&&(e.center={x:e.attributes.cx,y:e.attributes.cy}),"polygon"==n){var c=t.attr("points").split(" "),u=c.map(function(t){return t.split(",")[0]}),d=c.map(function(t){return t.split(",")[1]}),f=Math.min.apply(null,u),p=Math.max.apply(null,u),g=Math.min.apply(null,d),v=Math.max.apply(null,d),m={x:f,y:g,width:p-f,height:v-g};e.bbox=m,e.center={x:(f+p)/2,y:(g+v)/2}}return"path"==n&&(e.totalLength=t.node().getTotalLength()),"#text"==n?e.text=t.text():"#comment"==n&&(e.comment=t.text()),e}function c(t){var n=h(t);return n.children=[],e.selectAll(t.node().childNodes).each(function(){var t=c(e.select(this));t.parent=n,n.children.push(t)}),n}function u(t){return"#text"==t.tag?document.createTextNode(""):"#comment"==t.tag?document.createComment(t.comment):document.createElementNS("http://www.w3.org/2000/svg",t.tag)}function d(t){var n=u(t),r=e.select(n),i=t.attributes;for(var a of Object.keys(i)){var o=i[a];r.attr(a,o)}return n}function f(t,n){var r=e.select(t.node().parentNode),i=d(n),a=r.insert(function(){return i},function(){return t.node()});return t.remove(),a}function p(t){return Object.assign({},t)}function g(){var t=this._selection,n=e.select(t.node().querySelector("svg"));if(0==n.size())return this;this._zoomSelection=n;var r=o.zoom().scaleExtent([.1,10]).interpolate(a.interpolate).on("zoom",function(){i.attr("transform",e.event.transform)});this._zoomBehavior=r;var i=e.select(n.node().querySelector("g"));return n.call(r),this._active||m.call(this,i),this._originalTransform=o.zoomTransform(n.node()),this}function v(t){var e=this._translation,n=t.datum().translation,r=o.zoomTransform(this._zoomSelection.node());return e&&(r=r.translate(-e.x,-e.y)),r=r.translate(n.x,n.y)}function m(t){this._zoomBehavior.transform(this._zoomSelection,v.call(this,t)),this._translation=t.datum().translation,this._originalTransform=o.zoomIdentity.translate(t.datum().translation.x,t.datum().translation.y)}function y(t,e){return function(){var n=t.map(function(t){return a.interpolate([t[0][0],t[0][1]],[t[1][0],t[1][1]])});return function(t){return t<1?"M"+n.map(function(e){return e(t)}).join("L"):e}}}function _(t){return"edge"==t.attributes.class||"a"==t.tag&&"g"==t.parent.tag&&"edge"==t.parent.parent.attributes.class}function x(t){return t.parent&&_(t.parent)}function w(t){var n=this._transition,r=this._fade&&null!=n,i=this._tweenPaths,s=this._tweenShapes,l=this._convertEqualSidedPolygons,c=(this._tweenPrecision,this._growEnteringEdges&&null!=n),d=this._attributer,p=this;function w(t){var g=e.select(this);d&&g.each(d);var b=t.tag,E=t.attributes,P=!1;if(s&&n&&t.alternativeOld){if("polygon"==this.nodeName||"ellipse"==this.nodeName){P=!0;var k=h(g);if("polygon"==this.nodeName&&"polygon"==b){var z=k.attributes.points;if(!l){var M=z.split(" ").length;(W=t.attributes.points).split(" ").length==M&&(P=!1)}}}if(P){var S=t.alternativeOld,L=f(g,S);L.data([t],function(){return t.key});var q=t.alternativeNew;g=L,b="path",E=q.attributes}}var O=g;if(n&&(O=O.transition(n),r&&O.filter(function(t){return"#"==t.tag[0]?null:this}).style("opacity",1),O.filter(function(t){return"#"==t.tag[0]?null:this}).on("end",function(){e.select(this).attr("style",null)})),c&&"path"==b&&t.offset){var T=t.totalLength;g.attr("stroke-dasharray",T+" "+T).attr("stroke-dashoffset",T).attr("transform","translate("+t.offset.x+","+t.offset.y+")"),O.attr("stroke-dashoffset",0).attr("transform","translate(0,0)").on("start",function(){e.select(this).style("opacity",null)}).on("end",function(){e.select(this).attr("stroke-dashoffset",null).attr("stroke-dasharray",null).attr("transform",null)})}if(c&&"polygon"==b&&x(t)&&t.offset){var j=e.select(g.node().parentNode.querySelector("path")),N=j.node().getPointAtLength(0),A=j.node().getPointAtLength(t.totalLength),D=j.node().getPointAtLength(t.totalLength-1),B=180*Math.atan2(A.y-D.y,A.x-D.x)/Math.PI,U=N.x-A.x+t.offset.x,F=N.y-A.y+t.offset.y;g.attr("transform","translate("+U+","+F+")"),O.attrTween("transform",function(){return function(e){var n=j.node().getPointAtLength(t.totalLength*e),r=j.node().getPointAtLength(t.totalLength*e+1),i=180*Math.atan2(r.y-n.y,r.x-n.x)/Math.PI-B;return U=n.x-A.x+t.offset.x*(1-e),F=n.y-A.y+t.offset.y*(1-e),"translate("+U+","+F+") rotate("+i+" "+A.x+" "+A.y+")"}}).on("start",function(){e.select(this).style("opacity",null)}).on("end",function(){e.select(this).attr("transform",null)})}var I=i&&n&&"path"==b&&null!=g.attr("d");for(var R of Object.keys(E)){var V=E[R];if(I&&"d"==R){var W;(W=(t.alternativeOld||t).points)&&O.attrTween("d",y(W,V))}else{if("transform"==R&&t.translation){var C=O.on("end");O.on("start",function(){p._zoomBehavior&&O.tween("attr.transform",function(){var t=this;return function(e){t.setAttribute("transform",a.interpolateTransformSvg(o.zoomTransform(p._zoomSelection.node()).toString(),v.call(p,g).toString())(e))}})}).on("end",function(){C.call(this),p._zoomBehavior&&m.call(p,g)})}O.attr(R,V)}}P&&O.on("end",function(t,n,r){f(L=e.select(this),t).data([t],function(){return t.key})}),t.text&&O.text(t.text),function(t){var i=t.selectAll(function(){return t.node().childNodes}),a=(i=i.data(function(t){return t.children},function(t){return t.key})).enter().append(function(t){var e=u(t);return"#text"==t.tag&&r&&(e.nodeValue=t.text),e});(r||c&&_(t.datum()))&&a.filter(function(t){return"#"==t.tag[0]?null:this}).each(function(t){var n=e.select(this);for(var r of Object.keys(t.attributes)){var i=t.attributes[r];n.attr(r,i)}}).filter(function(t){return"svg"==t.tag||"g"==t.tag?null:this}).style("opacity",0);var o=i.exit();d&&o.each(d),n&&(o=o.transition(n),r&&o.filter(function(t){return"#"==t.tag[0]?null:this}).style("opacity",0)),o=o.remove(),(i=a.merge(i)).each(w)}(g)}var b=this._selection;if(null!=n){var E=this._jobs;if(p._active)return E.push(null),this;b.transition(n).transition().duration(0).on("end",function(){p._active=!1,0!=E.length&&(E.shift(),p.render())}),this._active=!0}null!=n&&b.transition(n).on("start",function(){p._dispatch.call("transitionStart",p)}).on("end",function(){p._dispatch.call("transitionEnd",p)}).transition().duration(0).on("start",function(){p._dispatch.call("restoreEnd",p),p._dispatch.call("end",p),t&&t.call(p)});var P=this._data,k=b.selectAll("svg").data([P],function(t){return t.key});return k=k.enter().append("svg").merge(k),w.call(k.node(),P),this._zoom&&!this._zoomBehavior&&g.call(this),p._dispatch.call("renderEnd",p),null==n&&(this._dispatch.call("end",this),t&&t.call(this)),this}function b(t,e){if("polygon"==t.tag){(u=p(t)).tag="path";var n=p(d=t.attributes),r=d.points;if("polygon"==e.tag){(f=t.bbox).cx=f.x+f.width/2,f.cy=f.y+f.height/2;for(var i=d.points.split(" "),a=i.map(function(t){var e=t.split(",");return[e[0]-f.cx,e[1]-f.cy]}),o=a[a.length-1][0],s=a[a.length-1][1],l=0;l<a.length;l++,o=_,s=x){var h=(_=a[l][0])-o;if(0!=(k=(x=a[l][1])-s))if(0<=(w=o-s*h/k)&&w<1/0&&(o<=w&&w<=_||_<=w&&w<=o))break}var c=[[f.cx+w,f.cy+0].join(",")];r=(c=(c=c.concat(i.slice(l))).concat(i.slice(0,l))).join(" ")}n.d="M"+r+"z",delete n.points,u.attributes=n}else{var u;(u=p(t)).tag="path";n=p(d=t.attributes);var d,f,g=d.cx,v=d.cy,m=d.rx,y=d.ry;(f=e.bbox).cx=f.x+f.width/2,f.cy=f.y+f.height/2;var _,x,w,b=e.attributes.points.split(" ")[0].split(","),E=b[0],P=b[1],k=(h=E-f.cx,P-f.cy),z=Math.sqrt(Math.pow(h,2)+Math.pow(k,2)),M=h/z,S=-k/z;h=(w=m*-M)-(_=m*M),k=-y*-S-(x=-y*S);n.d="M "+g+" "+v+" m "+_+","+x+" a "+m+","+y+" 0 1,0 "+h+","+k+" a "+m+","+y+" 0 1,0 "+-h+","+-k+"z",delete n.cx,delete n.cy,delete n.rx,delete n.ry,u.attributes=n}return u}function E(t){if("undefined"!=typeof Worker){var r=new Blob(['\n            onmessage = function(event) {\n                if (event.data.vizURL) {\n                    importScripts(event.data.vizURL);\n                }\n                try {\n                    var svg = Viz(event.data.dot, event.data.options);\n                }\n                catch(error) {\n                    postMessage({\n                        type: "error",\n                        error: error.message,\n                    });\n                    return;\n                }\n                if (svg) {\n                    postMessage({\n                        type: "done",\n                        svg: svg,\n                    });\n                } else {\n                    postMessage({\n                        type: "skip",\n                    });\n                }\n            }\n        ']),i=window.URL.createObjectURL(r);this._worker=new Worker(i)}this._selection=t,this._active=!1,this._busy=!1,this._jobs=[],this._queue=[],this._keyModes=new Set(["title","id","tag-index","index"]),this._engine="dot",this._images=[],this._totalMemory=void 0,this._keyMode="title",this._fade=!0,this._tweenPaths=!0,this._tweenShapes=!0,this._convertEqualSidedPolygons=!0,this._tweenPrecision=1,this._growEnteringEdges=!0,this._translation=void 0,this._zoom=!0,this._eventTypes=["initEnd","start","layoutStart","layoutEnd","dataExtractEnd","dataProcessPass1End","dataProcessPass2End","dataProcessEnd","renderStart","renderEnd","transitionStart","transitionEnd","restoreEnd","end"],this._dispatch=n.dispatch(...this._eventTypes),function(){if(null==this._worker)s(""),this._dispatch.call("initEnd",this);else{var t=e.selectAll("script").filter(function(){return"javascript/worker"==e.select(this).attr("type")}).attr("src"),n=this;this._worker.onmessage=function(t){n._dispatch.call("initEnd",this)},t.match(/^https?:\/\/|^\/\//i)||(t=document.location.protocol+"//"+document.location.host+"/"+t),this._worker.postMessage({dot:"",vizURL:t})}}.call(this)}function P(t){return new E(e.select(t))}E.prototype=P.prototype={constructor:E,engine:function(t){if(t!=this._engine&&null!=this._data)throw Error("Too late to change engine");return this._engine=t,this},addImage:function(t,e,n){return this._images.push({path:t,width:e,height:n}),this},totalMemory:function(t){return this._totalMemory=t,this},keyMode:function(t){if(!this._keyModes.has(t))throw Error("Illegal keyMode: "+t);if(t!=this._keyMode&&null!=this._data)throw Error("Too late to change keyMode");return this._keyMode=t,this},fade:function(t){return this._fade=t,this},tweenPaths:function(t){return this._tweenPaths=t,this},tweenShapes:function(t){return this._tweenShapes=t,t&&(this._tweenPaths=!0),this},convertEqualSidedPolygons:function(t){return this._convertEqualSidedPolygons=t,this},tweenPrecision:function(t){return this._tweenPrecision=t,this},growEnteringEdges:function(t){return this._growEnteringEdges=t,this},zoom:function(t){return this._zoom=t,this._zoom&&!this._zoomBehavior&&g.call(this),this},resetZoom:function(t){var e=this._zoomSelection;return t&&(e=e.transition(t)),e.call(this._zoomBehavior.transform,this._originalTransform),this},render:function(t){return this._busy?(this._queue.push(this.render.bind(this,t)),this):(this._dispatch.call("renderStart",this),this._transitionFactory?i.timeout(function(){this._transition=r.transition(this._transitionFactory()),w.call(this,t)}.bind(this),0):w.call(this,t),this)},dot:function(t,n){var r=this,i=this._worker,a=this._engine,o=this._images,l=this._totalMemory,h=this._keyMode,u=this._tweenPaths,f=this._tweenShapes,p=this._tweenPrecision,g=this._growEnteringEdges,v={},m=this._dictionary||{},y={},_=this._nodeDictionary||{};function w(t,e){if(u&&e&&("path"==e.tag||t.alternativeOld&&"path"==t.alternativeOld.tag)){var n=(t.alternativeNew||t).attributes.d;if(t.alternativeOld)var r=d(t.alternativeOld);else r=d(e);(t.alternativeOld||(t.alternativeOld={})).points=function(t,e,n){for(var r=t,i=r.cloneNode(),a=r.getTotalLength(),o=(i.setAttribute("d",e),i).getTotalLength(),s=[0],l=0,h=n/Math.max(a,o);(l+=h)<1;)s.push(l);return s.push(1),s.map(function(t){var e=r.getPointAtLength(t*a),n=i.getPointAtLength(t*o);return[[e.x,e.y],[n.x,n.y]]})}(r,n,p)}}function E(t,e=0,n){!function(t,e){var n=t.tag;if("index"==h)t.key=e;else if("#"!=n[0])if("id"==h)t.key=t.attributes.id;else if("title"==h){var r=t.children.find(function(t){return"title"==t.tag});r&&(t.key=r.children[0].text)}null==t.key&&(f&&("ellipse"!=n&&"polygon"!=n||(n="path")),t.key=n+"-"+e)}(t,e),function(t,e){var n=(e?e.id+".":"")+t.key;t.id=n}(t,n);var r=t.id,i=m[r];!function(t){v[t.id]=t}(t),function(t,e){f&&t.id in m&&("polygon"!=e.tag&&"ellipse"!=e.tag||e.tag==t.tag&&"polygon"!=t.tag||(t.alternativeOld=b(e,t),t.alternativeNew=b(t,e)))}(t,i),w(t,i);var a={};t.children.forEach(function(e){var n=e.tag;"ellipse"!=n&&"polygon"!=n||(n="path"),null==a[n]&&(a[n]=0),E(e,a[n]++,t)})}function P(t){!function(t){var e=t.tag;if(g&&t.parent&&"node"==t.parent.attributes.class&&"title"==e){var n=t.children[0].text;y[n]=t.parent}}(t),function(t){var e=t.id,n=t.tag,r=m[e];if(g&&!r&&t.parent&&x(t)&&("path"==n||"polygon"==n)){if("polygon"==n){var i=t.parent.children.find(function(t){return"path"==t.tag});t.totalLength=i.totalLength}var a=function(t){return function(t){return"edge"==t.parent.attributes.class?t.parent:t.parent.parent.parent}(t).children.find(function(t){return"title"==t.tag})}(t).children[0],o=a.text.split("->");2!=o.length&&(o=a.text.split("--"));var s=o[0],l=y[s],h=_[s];if(h){"g"==l.children[3].tag&&"a"==l.children[3].children[0].tag&&(l=l.children[3].children[0]),"g"==h.children[3].tag&&"a"==h.children[3].children[0].tag&&(h=h.children[3].children[0]);for(var c=l.children,u=0;u<c.length;u++)if("polygon"==c[u].tag||"ellipse"==c[u].tag){var d=c[u];break}if(void 0===d)throw Error("Unsupported start shape of node "+s+".\nPlease file an issue at https://github.com/magjac/d3-graphviz/issues");var f=h.children;for(u=0;u<f.length;u++)if("polygon"==f[u].tag||"ellipse"==f[u].tag){var p=f[u];break}if(void 0===p)throw Error("Unsupported previuous start shape of node "+s+".\nPlease file an issue at https://github.com/magjac/d3-graphviz/issues");t.offset={x:p.center.x-d.center.x,y:p.center.y-d.center.y}}}}(t),t.children.forEach(function(t){P(t)})}this._dispatch.call("start",this),this._busy=!0,this._dispatch.call("layoutStart",this);var k={format:"svg",engine:a,images:o,totalMemory:l};if(this._worker)i.postMessage({dot:t,options:k}),i.onmessage=function(t){switch(t.data.type){case"done":return M.call(r,t.data.svg);case"error":if(!r._onerror)throw t.data.error;r._onerror(t.data.error)}};else{try{var z=s(t,k)}catch(t){if(r._onerror)return void r._onerror(t.message);throw t.message}M.call(this,z)}function M(t){this._dispatch.call("layoutEnd",this);var r=e.select(document.createDocumentFragment()).append("div"),i=(new window.DOMParser).parseFromString(t,"image/svg+xml");r.append(function(){return i.documentElement});var a=c(r.select("svg"));this._dispatch.call("dataExtractEnd",this),E(a),this._dispatch.call("dataProcessPass1End",this),P(a),this._dispatch.call("dataProcessPass2End",this),this._data=a,this._dictionary=v,this._nodeDictionary=y,this._extractData=function(t,e,n){var r=c(t);return E(r,e,n),P(r),r},this._busy=!1,this._dispatch.call("dataProcessEnd",this),n&&n.call(this),this._queue.length>0&&this._queue.shift().call(this)}return this},renderDot:function(t,e){var n=this;return this.dot(t,function(){n.render(e)}),this},transition:function(t){return t instanceof Function?this._transitionFactory=t:this._transition=r.transition(t),this},active:function(t){var e=this._selection.selectWithoutDataPropagation("svg");return 0!=e.size()?r.active(e.node(),t):null},attributer:function(t){return this._attributer=t,this},on:function(t,e){return this._dispatch.on(t,e),this},onerror:function(t){return this._onerror=t,this},logEvents:function(t){var e=Date.now(),n={},r=this._eventTypes,i=Math.max(...r.map(t=>t.length));for(let h in r){let c=r[h];n[c]=[];var a,o,s=this;this.on(c+".log",t?function(){var t=Date.now(),r=n[c].length;n[c].push(t);var u="";if(u+="Event ",u+=l.format(" >2")(h)+" ",u+=c+" ".repeat(i-c.length),u+=l.format(" >5")(t-e)+" ","initEnd"!=c&&(u+=l.format(" >5")(t-n.start[r])),"dataProcessEnd"==c&&(u+=" prepare                 "+l.format(" >5")(t-n.layoutEnd[r])),"renderEnd"==c&&s._transition&&(u+=" transition start margin "+l.format(" >5")(s._transition.delay()-(t-n.renderStart[r])),a=s._transition.delay(),o=s._transition.duration()),"transitionStart"==c){var d=t-n.renderStart[r];u+=" transition delay        "+l.format(" >5")(t-n.renderStart[r]),u+=" expected "+l.format(" >5")(a),u+=" diff "+l.format(" >5")(d-a)}if("transitionEnd"==c){var f=t-n.transitionStart[r];u+=" transition duration     "+l.format(" >5")(f),u+=" expected "+l.format(" >5")(o),u+=" diff "+l.format(" >5")(f-o)}console.log(u),e=t}:null)}return this}},e.selection.prototype.graphviz=function(){return new E(this)},e.selection.prototype.selectWithoutDataPropagation=function(t){return e.select(this.node().querySelector(t))},t.graphviz=P,Object.defineProperty(t,"__esModule",{value:!0})});